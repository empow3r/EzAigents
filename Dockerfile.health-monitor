FROM node:20-alpine

WORKDIR /app

# Install system dependencies for health monitoring
RUN apk add --no-cache \
    curl \
    jq \
    bash \
    ca-certificates

# Copy package files
COPY package*.json ./
RUN npm ci --only=production --no-audit

# Copy shared coordination system
COPY shared ./shared

# Copy health monitoring scripts
COPY scripts/agent-health-monitor.sh ./scripts/
RUN chmod +x scripts/agent-health-monitor.sh

# Create directories
RUN mkdir -p logs .agent-memory

# Environment variables
ENV NODE_ENV=production
ENV HEALTH_MONITOR=true

# Health check for the health monitor itself
HEALTHCHECK --interval=60s --timeout=30s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8080/health || ./scripts/agent-health-monitor.sh status > /dev/null 2>&1 || exit 1

# Create simple health endpoint for the monitor
COPY <<EOF /app/health-endpoint.js
const http = require('http');

const server = http.createServer((req, res) => {
  if (req.url === '/health') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({
      status: 'healthy',
      service: 'health-monitor',
      uptime: process.uptime(),
      timestamp: new Date().toISOString()
    }));
  } else {
    res.writeHead(404);
    res.end('Not Found');
  }
});

server.listen(8080, '0.0.0.0', () => {
  console.log('Health monitor endpoint running on port 8080');
});
EOF

# Start script for health monitor
COPY <<EOF /app/start-health-monitor.sh
#!/bin/bash
set -e

echo "🏥 Starting Ez Aigent Health Monitor"

# Start health endpoint in background
node /app/health-endpoint.js &
HEALTH_PID=\$!

# Wait for Redis to be available
echo "⏳ Waiting for Redis..."
until redis-cli -u "\${REDIS_URL}" ping > /dev/null 2>&1; do
  echo "Waiting for Redis to be ready..."
  sleep 2
done
echo "✅ Redis is ready"

# Start continuous health monitoring
echo "🔄 Starting continuous agent health monitoring..."
exec ./scripts/agent-health-monitor.sh monitor

# Cleanup health endpoint process
kill \$HEALTH_PID 2>/dev/null || true
EOF

RUN chmod +x /app/start-health-monitor.sh

# Create non-root user for security
RUN addgroup -g 1001 -S ezaigent && \
    adduser -S ezaigent -u 1001 -G ezaigent

# Change ownership
RUN chown -R ezaigent:ezaigent /app

USER ezaigent

EXPOSE 8080

CMD ["/app/start-health-monitor.sh"]